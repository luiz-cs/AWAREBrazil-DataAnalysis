---
title: "Replication: Gaps in Early Warning Systems (EWSs) during  Brazil`s Largest Dengue Epidemic"
date: "`r format(Sys.Date(), '%Y-%m-%d')`"
lang: pt-BR
output:
  html_document:
    number_sections: true
    toc: true
    code_folding: hide
    latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = F, message = F)
if (.Platform$OS.type == "windows") {
  Sys.setlocale("LC_CTYPE", "Portuguese_Brazil.1252")
} else {
  Sys.setlocale("LC_CTYPE", "pt_BR.UTF-8")
}

library(tidyverse)
library(lubridate)
library(zoo)
library(ggplot2)
library(ggsci)
library(here)
library(haven)
library(readr)
library(stringr)
library(officer)
library(flextable)
library(geobr)
library(sf)
library(scales)
library(RColorBrewer)
library(patchwork)
```

---

# Data Preparation

## Gathering Data

```{r gather-data}
# All arbovirsuses data:
arboviruses_full <- read_csv(here("Data/cases_all_virus_2014_2024.csv")) %>% 
  mutate(
    likely_cases = tidyr::replace_na(likely_cases, 0),
    deaths = tidyr::replace_na(deaths, 0)) %>% 
  rename(calendar_year = year,
         calendar_week = week)  %>%
  mutate(virus = str_to_title(virus),
          calendar_year_week = paste0(calendar_year, "w", calendar_week)) 

# Epidemiological week starting on the first week of the winter
epiweek40 <- read_dta(
  here("Data/epidemiological_week_startsweek40.dta")) %>% 
  rename(calendar_year_week = wy,
         epi_week = epidemiologic_week_startsweek40,
         epi_year = year_week40) %>% 
  mutate(epi_week = as.numeric(epi_week),
         epi_year = as.numeric(epi_year)) %>% 
  mutate(epi_year_week = paste0(epi_year, "w", epi_week))

#List of municipalities of interest
codibge <- list(
  "Rio Branco"      = "120040",
  "Maceió"          = "270430",
  "Macapá"          = "160030",
  "Manaus"          = "130260",
  "Salvador"        = "292740",
  "Fortaleza"       = "230440",
  "Brasília"        = "530010",
  "Vitória"         = "320530",
  "Goiânia"         = "520870",
  "São Luís"        = "211130",
  "Cuiabá"          = "510340",
  "Campo Grande"    = "500270",
  "Belo Horizonte"  = "310620",
  "Belém"           = "150140",
  "João Pessoa"     = "250750",
  "Curitiba"        = "410690",
  "Recife"          = "261160",
  "Teresina"        = "221100",
  "Rio de Janeiro"  = "330455",
  "Natal"           = "240810",
  "Porto Alegre"    = "431490",
  "Porto Velho"     = "110020",
  "Boa Vista"       = "140010",
  "Florianópolis"   = "420540",
  "São Paulo"       = "355030",
  "Aracaju"         = "280030",
  "Palmas"          = "172100")
```

---

## Preparing Data

```{r preparing-data}
# 1. Create the base dataset
arboviruses_base <- arboviruses_full %>%
  select(ibge, calendar_year_week, municipality, uf, virus, likely_cases, deaths, population) %>%
  left_join(epiweek40, by = "calendar_year_week") %>%
  arrange(epi_year, epi_week) %>%
  filter(!is.na(municipality), !is.na(epi_year), !is.na(epi_week))

# 2. Calculate population for each epidemiological year
# States
state_population <- arboviruses_base %>%
  distinct(uf, ibge, epi_year, .keep_all = TRUE) %>%
  group_by(uf, epi_year) %>%
  summarise(state_pop = sum(population), .groups = "drop")

# Country
country_population <- arboviruses_base %>%
  distinct(ibge, epi_year, .keep_all = TRUE) %>%
  group_by(epi_year) %>%
  summarise(country_pop = sum(population), .groups = "drop")

# 3. Create datasets for each geographic level

# Munis (Individual Viruses)
arboviruses_muni_ind <- arboviruses_base %>%
  filter(ibge %in% unlist(codibge)) %>%
  group_by(ibge, municipality, uf, calendar_year_week, epi_year, epi_week, epi_year_week, virus) %>%
  summarise(
    cases = sum(likely_cases),
    deaths = sum(deaths),
    population = first(population), # pop is measured on year basis
    .groups = "drop"
  ) %>%
  mutate(
    incidence = (cases / population) * 100000,
    death_rate = (deaths / population) * 100000
  ) %>%
  # Calculate cumulative per epi year
  group_by(ibge, municipality, uf, virus, epi_year) %>%
  arrange(epi_week, .by_group = TRUE) %>%
  mutate(
    cumulative_incidence = cumsum(incidence),
    cumulative_death_rate = cumsum(death_rate)
  ) %>%
  ungroup()

# States (Individual Viruses)
arboviruses_state_ind <- arboviruses_base %>%
  group_by(uf, calendar_year_week, epi_year, epi_week, epi_year_week, virus) %>%
  summarise(
    cases = sum(likely_cases),
    deaths = sum(deaths),
    .groups = "drop"
  ) %>%
  full_join(state_population, by = c("uf", "epi_year")) %>%
  mutate(
    incidence = (cases / state_pop) * 100000,
    death_rate = (deaths / state_pop) * 100000
  ) %>%
  # Calculate cumulative per epi year
  group_by(uf, virus, epi_year) %>%
  arrange(epi_week, .by_group = TRUE) %>%
  mutate(
    cumulative_incidence = cumsum(incidence),
    cumulative_death_rate = cumsum(death_rate)
  ) %>%
  ungroup()

# Country (Individual Viruses)
arboviruses_country_ind <- arboviruses_base %>%
  group_by(calendar_year_week, epi_year, epi_week, epi_year_week, virus) %>%
  summarise(
    cases = sum(likely_cases),
    deaths = sum(deaths),
    .groups = "drop"
  ) %>%
  left_join(country_population, by = "epi_year") %>%
  mutate(
    incidence = (cases / country_pop) * 100000,
    death_rate = (deaths / country_pop) * 100000,
    country = "Brazil"
  ) %>%
  # Calculate cumulative per epi year
  group_by(country, virus, epi_year) %>%
  arrange(epi_week, .by_group = TRUE) %>%
  mutate(
    cumulative_incidence = cumsum(incidence),
    cumulative_death_rate = cumsum(death_rate)
  ) %>%
  ungroup()

# 4. Create data for the sum of arboviruses

# Muni (Sum of Viruses)
all_virus_muni <- arboviruses_muni_ind %>%
  group_by(ibge, municipality, uf, calendar_year_week, epi_year, epi_week, epi_year_week) %>%
  summarise(
    cases = sum(cases),
    deaths = sum(deaths),
    population = first(population),
    .groups = "drop"
  ) %>%
  mutate(
    incidence = (cases / population) * 100000,
    death_rate = (deaths / population) * 100000,
    virus = "Sum of Arboviruses"
  ) %>%
  # Calculate cumulative per epi year
  group_by(ibge, municipality, uf, virus, epi_year) %>%
  arrange(epi_week, .by_group = TRUE) %>%
  mutate(
    cumulative_incidence = cumsum(incidence),
    cumulative_death_rate = cumsum(death_rate)
  ) %>%
  ungroup()

# States (Sum of Viruses)
all_virus_state <- arboviruses_state_ind %>%
  group_by(uf, calendar_year_week, epi_year, epi_week, epi_year_week) %>%
  summarise(
    cases = sum(cases),
    deaths = sum(deaths),
    .groups = "drop"
  ) %>%
  left_join(state_population, by = c("uf", "epi_year")) %>%
  mutate(
    incidence = (cases / state_pop) * 100000,
    death_rate = (deaths / state_pop) * 100000,
    virus = "Sum of Arboviruses"
  ) %>%
  # Calculate cumulative per epi year
  group_by(uf, virus, epi_year) %>%
  arrange(epi_week, .by_group = TRUE) %>%
  mutate(
    cumulative_incidence = cumsum(incidence),
    cumulative_death_rate = cumsum(death_rate)
  ) %>%
  ungroup()

# Country (Sum of Viruses)
all_virus_country <- arboviruses_country_ind %>%
  group_by(calendar_year_week, epi_year, epi_week, epi_year_week) %>%
  summarise(
    cases = sum(cases),
    deaths = sum(deaths),
    .groups = "drop"
  ) %>%
  left_join(country_population, by = "epi_year") %>%
  mutate(
    incidence = (cases / country_pop) * 100000,
    death_rate = (deaths / country_pop) * 100000,
    country = "Brazil",
    virus = "Sum of Arboviruses"
  ) %>%
  # Calculate cumulative per epi year
  group_by(country, virus, epi_year) %>%
  arrange(epi_week, .by_group = TRUE) %>%
  mutate(
    cumulative_incidence = cumsum(incidence),
    cumulative_death_rate = cumsum(death_rate)
  ) %>%
  ungroup()

# 5. Bind the datasets
arboviruses_muni <- bind_rows(arboviruses_muni_ind, all_virus_muni) %>%
  mutate(muni_name = stringr::str_remove(municipality, "^\\d+\\s"))  %>%
  arrange(epi_year, epi_week) %>%
  mutate(epi_year_week = factor(epi_year_week, levels = unique(epi_year_week), ordered = TRUE))
arboviruses_state <- bind_rows(arboviruses_state_ind, all_virus_state)  %>%
  arrange(epi_year, epi_week) %>%
  mutate(epi_year_week = factor(epi_year_week, levels = unique(epi_year_week), ordered = TRUE))
arboviruses_country <- bind_rows(arboviruses_country_ind, all_virus_country)  %>%
  arrange(epi_year, epi_week) %>%
  mutate(epi_year_week = factor(epi_year_week, levels = unique(epi_year_week), ordered = TRUE))
```

---

# Data Visualization

---

# Plotting Function

```{r funct-plot}
create_arbovirus_plot <- function(data, y_var, virus_filter_expr, y_lab,
                                  grouping_var, legend_position,
                                  facet_by = NULL,
                                  year_interval = 1,
                                  file_name) {

  # Use quosures for tidy evaluation
  y_var_quo <- enquo(y_var)
  grouping_var_quo <- enquo(grouping_var)
  virus_filter_quo <- enquo(virus_filter_expr)

  # Find the data for the first week of each epidemiological year
  axis_break_data <- data %>%
    group_by(epi_year) %>%
    slice_head(n = 1) %>%
    ungroup() %>%
    slice(seq(1, n(), by = year_interval))
    
  # Get the epi_year_week values for the axis break positions
  axis_breaks <- axis_break_data %>% pull(epi_year_week)
  
  # Get the corresponding calendar_year_week values for the axis labels
  axis_labels <- axis_break_data %>% pull(calendar_year_week)

  # Build the plot
  p <- data %>%
    arrange(epi_year, epi_week) %>%
    filter(!!virus_filter_quo) %>%
    ggplot(aes(x = epi_year_week, y = !!y_var_quo, group = !!grouping_var_quo, color = virus)) +
    geom_line(alpha = 0.8, linewidth = 0.9) +
    scale_color_lancet(name = "Virus") +
    labs(
      x = "Epidemiological Year-Week",
      y = y_lab
    ) +
    scale_x_discrete(breaks = axis_breaks, labels = axis_labels) +
    theme_classic(base_size = 14) + 
    theme(
      axis.title = element_text(face = "bold", size = rel(1)), 
      legend.position = legend_position,
      legend.title = element_text(face = "bold", size = rel(1)),
      legend.text = element_text(size = rel(1)),
      panel.grid.major.y = element_line(color = "grey85", linewidth = 0.5),
      axis.text.x = element_text(angle = 45, hjust = 1)
    )

  # Add faceting if specified
  if (!is.null(facet_by)) {
    p <- p + facet_wrap(vars(!!sym(facet_by)), scales = "free_y")
  }

  # Print and save
  print(p)
  ggsave(
    here("Graphs", file_name),
    p,
    height = 15,
    width = 15,
    dpi = 300,
    create.dir = TRUE
  )
}
```

---

## Incidence

### Country-wide Incidence

#### Dengue
```{r incidence-country-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = incidence,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  file_name = "Incidence of Dengue in Brazil.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r incidence-country-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = incidence,
  virus_filter_expr = virus != "Sum of Arboviruses",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  file_name = "Incidence of All Arboviruses in Brazil.png"
)
```

### State-level Incidence

#### Dengue
```{r incidence-state-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = incidence,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Incidence of Dengue per State.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r incidence-state-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = incidence,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Incidence of All Arboviruses per State.png"
)
```

### Selected Municipalities Incidence

#### Dengue
```{r incidence-muni-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = incidence,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Incidence of Dengue per Selected Municipalities.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r incidence-muni-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = incidence,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Incidence Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Incidence of All Arboviruses per Selected Municipalities.png"
)
```

---

## Mortality

### Country-wide Deaths

#### Dengue
```{r deaths-country-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = death_rate,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Death Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  file_name = "Deaths of Dengue in Brazil.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r deaths-country-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_country,
  y_var = death_rate,
  virus_filter_expr = virus != "Sum of Arboviruses",
  y_lab = "Death Rate (per 100,000 pop.)",
  grouping_var = virus,
  legend_position = "top",
  file_name = "Deaths of All Arboviruses in Brazil.png"
)
```

### State-level Deaths

#### Dengue
```{r deaths-state-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = cumulative_death_rate,
  virus_filter_expr = virus == "Dengue",
  y_lab = "Cumulative Death Rate (per 100,000 pop.) per Epidemiological Year",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Deaths of Dengue per State.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r deaths-state-all, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_state,
  y_var = cumulative_death_rate,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Cumulative Death Rate (per 100,000 pop.) per Epidemiological Year",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "uf",
  year_interval = 2,
  file_name = "Deaths of All Arboviruses per State.png"
)
```

### Selected Municipalities Deaths

#### Dengue
```{r deaths-muni-dengue, fig.width=15, fig.height=15}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = cumulative_death_rate,
 virus_filter_expr = virus == "Dengue",
  y_lab = "Cumulative Death Rate (per 100,000 pop.) per Epidemiological Year",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Deaths of Dengue per Selected Municipalities.png"
)
```

#### Dengue, Chikungunya, and Zika
```{r deaths-muni-all, fig.width=15, fig.height=10}
create_arbovirus_plot(
  data = arboviruses_muni,
  y_var = cumulative_death_rate,
  virus_filter_expr = virus == "Sum of Arboviruses",
  y_lab = "Cumulative Death Rate (per 100,000 pop.) per Epidemiological Year",
  grouping_var = virus,
  legend_position = "top",
  facet_by = "muni_name",
  year_interval = 2,
  file_name = "Deaths of All Arboviruses per Selected Municipalities.png"
)
```

---

## Mapping Incidence and Mortality in 2024

```{r spatial}
# Get Geospatial Data
#---------------------------------
states_sf <- read_state(year = 2020)
capitals_points <- read_municipality(year = 2020) %>%
  st_centroid() %>%
  mutate(code_muni = as.double(substr(as.character(code_muni), 1, 6)))
```

### Dengue

```{r mapping-dengue, fig.width=12, fig.height=10}
# Define the Epidemiological Year of Interest
epi_year_to_plot <- 2024

# Combine Data with Map
dengue_states_map_data <- arboviruses_state %>%
  filter(epi_year == epi_year_to_plot,
         virus == "Dengue") %>%
  slice_max(order_by = epi_week, n = 1) %>%
  left_join(states_sf, ., by = c("abbrev_state" = "uf"))

dengue_capitals_map_data <- arboviruses_muni %>%
  filter(epi_year == epi_year_to_plot,
         virus == "Dengue",
         ibge %in% codibge) %>%
  slice_max(order_by = epi_week, n = 1) %>%
  left_join(capitals_points, ., by = c("code_muni" = "ibge")) %>% 
  filter(!is.na(municipality), !is.na(epi_year), !is.na(epi_week))

# Define breaks for Incidence
inc_breaks <- c(0, 500, 2500, Inf) 
inc_labels <- c("0 - 499", "500 - 2,499", "2,500+")

# Define breaks for Death Rate
dengue_death_rate_breaks <- c(0, 2, 5, Inf) 
dengue_death_rate_labels <- c("0 - 1.9", "2 - 4.9", "5+")

# Apply these unified breaks and clean labels to both datasets
dengue_states_map_data <- dengue_states_map_data %>%
  mutate(
    incidence_cat = cut(cumulative_incidence, breaks = inc_breaks, labels = inc_labels, include.lowest = TRUE, right = FALSE),
    death_rate_cat = cut(cumulative_death_rate, breaks = dengue_death_rate_breaks, labels = dengue_death_rate_labels, include.lowest = TRUE, right = FALSE)
  )
dengue_capitals_map_data <- dengue_capitals_map_data %>%
  mutate(
    incidence_cat = cut(cumulative_incidence, breaks = inc_breaks, labels = inc_labels, include.lowest = TRUE, right = FALSE),
    death_rate_cat = cut(cumulative_death_rate, breaks = dengue_death_rate_breaks, labels = dengue_death_rate_labels, include.lowest = TRUE, right = FALSE)
  )

# Generate the Maps
#---------------------------------

### MAP 1: CUMULATIVE INCIDENCE

dengue_incidence_map_themed <- ggplot() +
  geom_sf(data = dengue_states_map_data, aes(fill = incidence_cat), color = "black", linewidth = 0.5) +
  geom_sf(data = dengue_capitals_map_data, aes(size = incidence_cat), shape = 21, fill = NA, color = "darkgrey", alpha = 1, stroke = 2) +
   scale_fill_brewer(
    palette = "Blues",
    name = "Cumulative Incidence (S)\n(per 100,000 pop.)",
    na.translate = FALSE,
    drop = TRUE 
  ) +
  scale_size_manual(
    name = "Cumulative Incidence (C)\n(per 100,000 pop.)",
    values = c(3, 6, 9),
    drop = FALSE
  ) +
   guides(
    fill = guide_legend(order = 1),
    size = guide_legend(order = 2)
  ) +
  theme_bw() +
  theme(
    legend.position = c(0.8, 0.1),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(fill = "transparent"),
    legend.box.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.title = element_text(),
    axis.text = element_text()
  )

print(dengue_incidence_map_themed)
ggsave(here("Graphs", paste0("Map Dengue Incidence 2024.png")), dengue_incidence_map_themed, width = 12, height = 10, dpi = 300)

### MAP 2: CUMULATIVE DEATH RATE

dengue_deaths_rate_map_themed <- ggplot() +
  geom_sf(data = dengue_states_map_data, aes(fill = death_rate_cat), color = "black", linewidth = 0.5) +
  geom_sf(data = dengue_capitals_map_data, aes(size = death_rate_cat), 
           shape = 21, fill = NA, color = "darkgrey", alpha = 1,stroke = 2) +
  scale_fill_brewer(
    palette = "Purples",
    name = "Cumulative Death Rate (S)\n(per 100,000 pop.)",
    na.translate = FALSE,
    drop = FALSE
  ) +
  scale_size_manual(
    name = "Cumulative Death Rate (C)\n(per 100,000 pop.)",
    values = c(3, 6, 9),
    drop = FALSE
  ) +
   guides(
    fill = guide_legend(order = 1),
    size = guide_legend(order = 2)
  ) +
  theme_bw() +
  theme(
    legend.position = c(0.8, 0.1),
    legend.justification = c("left", "bottom"),
    legend.background = element_rect(fill = "transparent"),
    legend.box.background = element_blank(),
    panel.grid = element_blank(),
    panel.border = element_blank(),
    axis.title = element_text(),
    axis.text = element_text()
  )

print(dengue_deaths_rate_map_themed)
ggsave(here("Graphs", paste0("Map Dengue Death 2024.png")), dengue_deaths_rate_map_themed, width = 12, height = 10, dpi = 300)
```

# Risk Assessment

## Risk assessment function

```{r risk-function}
risk_analysis <- function(df, analysis_year = 2024) {
  
  # === PART 1: PREPARE DATA & BUILD ENDEMIC CHANNEL ===
  
  # Create the endemic channel using all years >= 2015, excluding the analysis year
  endemic_channel <- df %>%
    filter(epi_year >= 2015 & epi_year != analysis_year) %>%
    group_by(epi_week) %>%
    summarise(
      median_incidence = median(incidence),
      high = quantile(incidence, 0.75),
      low = quantile(incidence, 0.25),
      .groups = "drop"
    )
  
  # Isolate the current year's data for the analysis
  current_year_data <- df %>%
    filter(epi_year == analysis_year) %>%
    select(calendar_year_week, epi_week, incidence_current = incidence, deaths_current = deaths)
  
  # Combine endemic channel and current year data
  
  max_week <- max(df$epi_week[df$epi_year == analysis_year], na.rm = TRUE) # Dynamically find the maximum epi_week for the specified analysis_year
  
  risk_final <- tibble(epi_week = 1:max_week) %>%  
    left_join(endemic_channel, by = "epi_week") %>%
    left_join(current_year_data, by = "epi_week") %>%
    # Replace NA values with 0 to allow for calculations
    mutate(
      across(everything(), ~replace_na(., 0))
    )
  
  # === PART 2: APPLY RISK ASSESSMENT RULES ===
  
  risk_final <- risk_final %>%
    arrange(epi_week) %>%
    mutate(
      # Condition 1: Increased incidence between median and high threshold for 4 weeks
      increased_incidence_within = ifelse(incidence_current > median_incidence & incidence_current < high , 1, 0),
      increased_incidence_within_4w = zoo::rollapply(
        increased_incidence_within, 4,
        function(x) as.integer(all(x == 1)),
        fill = 0, align = "right"),
      
      # Condition 2: Increased incidence above high threshold for 4 weeks
      increased_incidence_high = ifelse(incidence_current > high , 1, 0),
      increased_incidence_high_4w = zoo::rollapply(
        increased_incidence_high, 4,
        function(x) as.integer(all(x == 1)),
        fill = 0, align = "right"),
      
      # Condition 3: Increased deaths for 4 weeks
      increased_deaths = ifelse(deaths_current > lag(deaths_current, 1) , 1, 0),
      increased_deaths_4w = zoo::rollapply(
        increased_deaths, 4,
        function(x) as.integer(all(x == 1)),
        fill = 0, align = "right"),
      
       # Condition 4: Deaths per cases above 0.05%
      lethality = ifelse(incidence_current > 0, (deaths_current / incidence_current) > 0.0005, 0),
      
      # Condition 5: Exponential increase in incidence AND incidence above high threshold 
      exponential_incidence = ifelse(incidence_current > 0 & lag(incidence_current, 1) > 0,
                                     log(incidence_current) > log(lag(incidence_current, 1)) &
                                       incidence_current > high, 0),
      
      # Condition 6: Increased deaths for more than 4 weeks (5 weeks)
      increased_deaths_5w = zoo::rollapply(
        increased_deaths, 5,
        function(x) as.integer(all(x == 1)),
        fill = 0, align = "right"),
        
    # Assign a risk level based on a nested, hierarchical logic
      riskassessment = case_when(
      epi_week <= 4 ~ -1L,
      
      # EPIDEMIC - Condition 5 AND/OR Condition 6
      (exponential_incidence == 1 & increased_deaths_5w == 1) |
      (exponential_incidence == 1 | increased_deaths_5w == 1) ~ 3L,
      
      # ALERT - Condition 2 AND/OR Condition 3 AND/OR Condition 4
      (increased_incidence_high_4w == 1 & increased_deaths_4w == 1 & lethality == 1) |
      (increased_incidence_high_4w == 1 & increased_deaths_4w == 1) |
     (increased_incidence_high_4w == 1 & lethality == 1) |
      (increased_deaths_4w == 1 & lethality == 1) |
     (increased_incidence_high_4w == 1 | increased_deaths_4w == 1 | lethality == 1) ~ 2L,
  
      # Mobilization - Condition 1
      increased_incidence_within_4w == 1 ~ 1L,
   
        # Default: Normality
        TRUE ~ 0L
      )
    ) 
  
    return(list(risk_final = risk_final))
}
```

### Running Risk assessment function

```{r risk-func-run}
# Country Level
nested_data_country <- arboviruses_country %>%
  group_by(country, virus) %>%
  nest()

results_country <- nested_data_country %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_country_filtered <- results_country %>%
  filter(!map_lgl(risk_analysis_results, is.null))

risk_2024_country <- results_country_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(country, virus, risk_data) %>%
  unnest(cols = c(risk_data))

# State Level
nested_data_state <- arboviruses_state %>%
  group_by(uf, virus) %>%
  nest()

results_state <- nested_data_state %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_state_filtered <- results_state %>%
  filter(!map_lgl(risk_analysis_results, is.null))
  
risk_2024_state <- results_state_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(uf, virus, risk_data) %>%
  unnest(cols = c(risk_data))

# Municipality Level
nested_data_muni <- arboviruses_muni %>%
  group_by(municipality, muni_name, virus, ibge) %>%
  nest()

results_muni <- nested_data_muni %>%
  mutate(risk_analysis_results = map(data, risk_analysis))

results_muni_filtered <- results_muni %>%
  filter(!map_lgl(risk_analysis_results, is.null))

risk_2024_muni <- results_muni_filtered %>%
  mutate(risk_data = map(risk_analysis_results, ~ .x$risk_final)) %>%
  select(municipality, muni_name, ibge, virus, risk_data) %>%
  unnest(cols = c(risk_data))
```

### Summary Table of Risk Assessment

```{r table-risk-summary}
# --- Country Level Table ---

# Calculate first alert week
alert_week_country <- risk_2024_country %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  group_by(location_name = country, virus) %>%
  summarise(first_week_alert_2024 = min(epi_week[riskassessment >= 2], na.rm = TRUE), .groups = 'drop') %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf))

# Display the table
knitr::kable(alert_week_country,
             caption = "Country Level: First Alert Week in 2024 (Level >= 2)",
             col.names = c("Country", "Virus", "2024 First Alert Week"))


# --- State Level Table ---

# Calculate first alert week
alert_week_state <- risk_2024_state %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  group_by(location_name = uf, virus) %>%
  summarise(first_week_alert_2024 = min(epi_week[riskassessment >= 2], na.rm = TRUE), .groups = 'drop') %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf))

# Display the table
knitr::kable(alert_week_state,
             caption = "State Level: First Alert Week in 2024 (Level >= 2)",
             col.names = c("UF", "Virus", "2024 First Alert Week"))


# --- Municipality Level Table ---

# Calculate first alert week
alert_week_muni <- risk_2024_muni %>%
  filter(virus %in% c("Dengue", "Sum of Arboviruses")) %>%
  group_by(location_name = muni_name, ibge, virus) %>%
  summarise(first_week_alert_2024 = min(epi_week[riskassessment >= 2], na.rm = TRUE), .groups = 'drop') %>%
  mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
  mutate(first_week_alert_2024 = na_if(first_week_alert_2024, Inf))

# Display the table
knitr::kable(alert_week_muni,
             caption = "Selected Municipalities: First Alert Week in 2024 (Level >= 2)",
             col.names = c("Municipality", "IBGE", "Virus", "2024 First Alert Week"))


# Create word docx
doc <- read_docx()

# --- Country Level ---
doc <- doc %>%
  body_add_par("Country Level: First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(alert_week_country)) %>%
  body_add_par("")

# --- State Level ---
doc <- doc %>%
  body_add_par("State Level: First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(alert_week_state)) %>%
  body_add_par("")

# --- Municipality Level ---
doc <- doc %>%
  body_add_par("Municipality Level: First Alert Week in 2024 (Level >= 2)", style = "heading 1") %>%
  body_add_flextable(flextable(alert_week_muni)) %>%
  body_add_par("")

# Save
print(doc, target = "epidemic_tables.docx")
```

### Combining with Emergency Declarations in Epidemiological Year 2024

```{r preparing-risk-data}
# Country Risk Assessment
risk_2024_country <- risk_2024_country %>%
  mutate(epi_week = as.numeric(epi_week),
         riskassessment = as.factor(riskassessment))

# States Risk Assessment
risk_2024_state <- risk_2024_state %>%
  mutate(epi_week = as.numeric(epi_week),
         riskassessment = as.factor(riskassessment))

# Municipalities Risk Assessment
risk_2024_muni <- risk_2024_muni %>%
  mutate(epi_week = as.numeric(epi_week),
         riskassessment = as.factor(riskassessment))

# Creation of the Centro de Operações de Emergências de Saúde Pública para Dengue e outras Arboviroses, no âmbito do Ministério da Saúde
emergency_country <- tibble::tibble(
  label = "02/02/2024",
  date_issued = dmy("02/02/2024")
) %>%
  mutate(
    year = year(date_issued),
    week = week(date_issued), # Get standard week number
    calendar_year_week = paste0(year, "w", as.integer(week)) # Create a join key (e.g., "2024w5")
  ) %>%
  left_join(epiweek40, by = "calendar_year_week") 

# State Emergency Declarations
emergency_state <- tibble::tribble(
    ~uf, ~date_issued,
    "AC", "05/01/2024",
    "DF", "25/01/2024",
    "GO", "02/02/2024",
    "ES", "21/02/2024",
    "RJ", "21/02/2024",
    "SC", "22/02/2024", 
    "MG", "26/02/2024",
    "AP", "28/02/2024",
    "SP", "05/03/2024",
    "RS", "12/03/2024",
    "PR", "14/03/2024"
  ) %>%
  mutate(
    date_issued = dmy(date_issued),
    year = year(date_issued),
    week = week(date_issued), # Get standard week number
    calendar_year_week = paste0(year, "w", as.integer(week)) # Create a join key
  ) %>%
  left_join(epiweek40, by = "calendar_year_week") 

# Municipal Emergency Declarations
emergency_muni <- tibble::tribble(
    ~ibge, ~date_issued,
    420540, "29/11/2023",  # Florianópolis
    330455, "02/02/2024",  # Rio de Janeiro
    310620, "16/02/2024",  # Belo Horizonte
  #  420540, "22/02/2024",  # Florianópolis 
    240810, "01/03/2024",  # Natal
    520870, "13/03/2024",  # Goiânia
    355030, "18/03/2024",  # São Paulo
    431490, "22/04/2024"   # Porto Alegre
  ) %>%
  mutate(
    ibge = as.numeric(ibge), # Ensure type matches other data
    date_issued = dmy(date_issued),
    year = year(date_issued),
    week = week(date_issued),
    calendar_year_week = paste0(year, "w", as.integer(week))
  ) %>%
  left_join(epiweek40, by = "calendar_year_week") %>%
  left_join(
    arboviruses_muni %>% distinct(ibge, muni_name),
    by = "ibge"
  )

# Aggregate labels for states declaring emergency in the same week
emergency_state_labels <- emergency_state %>%
  group_by(epi_week) %>%
  summarise(uf_labels = paste(uf, collapse = "\n"))

# Create the state emergency data needed for the municipal plots
muni_info <- arboviruses_muni %>%
  distinct(muni_name, uf)

emergency_state_for_muni_plot <- emergency_state %>%
  left_join(muni_info, by = "uf", relationship = "many-to-many") %>%
  filter(!is.na(epi_week))
```

## Visualizing Risk Assessment and Emergency Declarations in 2024

```{r function-risk-plot}
create_risk_plot <- function(data, facet_var = NULL) {
  
  # Define axis breaks and find their corresponding calendar week labels
  axis_breaks <- seq(min(data$epi_week), max(data$epi_week), by = 13) %>% 
    union(max(data$epi_week))
  axis_labels <- data$calendar_year_week[match(axis_breaks, data$epi_week)]
  
  # Order risk assessment as factor
  all_levels <- c("-1", "0", "1", "2", "3")
  
  plot_data <- data %>%
    mutate(riskassessment = factor(riskassessment, levels = all_levels))
  
  dummy_data <- tibble(riskassessment = factor(all_levels, levels = all_levels))
  
  # Base plot
  p <- plot_data %>%
    ggplot(aes(x = epi_week)) +
    # Incidence bars colored by risk level
    geom_col(aes(y = incidence_current, fill = riskassessment), width = 1, alpha = 0.8) +
    # Endemic channel 
    geom_ribbon(aes(ymin = low, ymax = high, fill = "Endemic Channel", group = 1), alpha = 0.8) +
    # Median incidence line
    geom_line(aes(y = median_incidence, color = "Historical Median", linetype = "Historical Median", group = 1), linewidth = 0.8) +
    # Add an invisible layer that uses the dummy data to make sure all factors are present
    geom_tile(data = dummy_data, mapping = aes(x = -Inf, y = -Inf, fill = riskassessment), alpha = 0) +
    # Scale x-axis
    scale_x_continuous(breaks = axis_breaks, labels = axis_labels) +
    # Define custom colors and labels for the fill aesthetic (Risk Levels)
    scale_fill_manual(
       name = "Risk Level & Baseline",
  values = c(
    "Endemic Channel" = "darkgrey",
    "-1" = "lightgrey",
    "0" = "green",
    "1" = "yellow",
    "2" = "orange",
    "3" = "red"),
  labels = c(
    "Endemic Channel" = "Endemic Channel",
    "-1" = "Learning",
    "0" = "Level 0 - Normality",
    "1" = "Level 1 - Mobilization",
    "2" = "Level 2 - Alert",
    "3" = "Level 3 - Epidemic"), 
  drop = FALSE,
  na.translate = T,
  limits = c("Endemic Channel", "-1", "0", "1", "2", "3")) +
  # Define manual color for historical Median line
  scale_color_manual(
  values = c("Historical Median" = "blue")) +
  # Define manual linetype for historical Median line
  scale_linetype_manual(
  values = c("Historical Median" = "dashed")) +
  guides(
      fill = guide_legend(
        title = NULL,
        order = 1,
        nrow = 1, 
        override.aes = list(alpha = 1) # 
      ),
      color = guide_legend(
        title = NULL,
        order = 2,
        override.aes = list(linetype = "dashed", color = "blue")
      ),
      linetype = "none"
    ) +
theme_classic(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold", size = rel(1.2)),
      axis.title = element_text(face = "bold", size = rel(1)),
      legend.position = "bottom",
      legend.title = element_text(face = "bold", size = rel(1)),
      legend.text = element_text(size = rel(0.9)),
      panel.grid.major.y = element_line(color = "grey90", linewidth = 0.5), # Add subtle grid lines
      strip.background = element_rect(fill = "grey92", color = NA), # Style facet titles
      strip.text = element_text(face = "bold", size = rel(0.9)),
      legend.box = "vertical",
      axis.text.x = element_text(angle = 45, hjust = 1)
    ) +
    labs(
      y = "Incidence Rate (per 100,000)", x = "Epidemiological Week")

  # Add faceting if a facet variable is provided
  if (!is.null(facet_var)) {
    p <- p + facet_wrap(vars(!!sym(facet_var)), scales = "free_y")
  }
  
  return(p)
}
```

### Country-wide

#### Dengue
```{r risk-country-dengue, fig.width=12, fig.height=10}
dengue_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Dengue")) +
  geom_vline(data = emergency_country, aes(xintercept = epi_week), linetype = "solid", color = "black", size = 1) +
  geom_vline(data = emergency_state, aes(xintercept = epi_week), linetype = "dashed", color = "black", size = 1) +
  geom_text(data = emergency_state_labels, aes(x = epi_week, y = 220, label = uf_labels), vjust = 1.5, size = 3.5)

print(dengue_risk_country)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 in Brazil with Emergency Dec.png"), dengue_risk_country, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

#### Dengue, Chikungunya, and Zika
```{r risk-country-threee, fig.width=12, fig.height=10}
sum_risk_country <- create_risk_plot(
  data = risk_2024_country %>% filter(virus == "Sum of Arboviruses")) +
  geom_vline(data = emergency_country, aes(xintercept = epi_week), linetype = "solid", color = "black", size = 1) +
  geom_vline(data = emergency_state, aes(xintercept = epi_week), linetype = "dashed", color = "black", size = 1) +
  geom_text(data = emergency_state_labels, aes(x = epi_week, y = 230, label = uf_labels), vjust = 1.5, size = 3.5)

print(sum_risk_country)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 in Brazil with Emergency Dec.png"), sum_risk_country, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

### State-level 

#### Dengue
```{r risk-state-dengue, fig.width=12, fig.height=10}
dengue_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Dengue"),
  facet_var = "uf") + 
  geom_vline(data = emergency_state, aes(xintercept = epi_week), linetype = "dashed", color = "black", size = 1.5)

print(dengue_risk_state)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 per State with Emergency Dec.png"), dengue_risk_state, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```
    
#### Dengue, Chikungunya, and Zika
```{r risk-state-threee, fig.width=12, fig.height=10}
sum_risk_state <- create_risk_plot(
  data = risk_2024_state %>% filter(virus == "Sum of Arboviruses"),
  facet_var = "uf") + 
  geom_vline(data = emergency_state, aes(xintercept = epi_week), linetype = "dashed", color = "black", size = 1.5)

print(sum_risk_state)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 per State with Emergency Dec.png"), sum_risk_state, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

### Selected Municipalities

#### Dengue
```{r risk-muni-dengue, fig.width=12, fig.height=10}
dengue_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Dengue"),
  facet_var = "muni_name") +
  geom_vline(data = emergency_muni, aes(xintercept = epi_week), linetype = "dotted", color = "black", size = 1.5) +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = epi_week), linetype = "dashed", color = "black", size = 1.5)

print(dengue_risk_muni)
ggsave(here("Graphs/Risk Levels of Dengue Outbreak in 2024 per Municipality with Emergency Dec.png"), dengue_risk_muni, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

#### Dengue, Chikungunya, and Zika
```{r risk-muni-threee, fig.width=12, fig.height=10}
sum_risk_muni <- create_risk_plot(
  data = risk_2024_muni %>% filter(virus == "Sum of Arboviruses"),
  facet_var = "muni_name") +
  geom_vline(data = emergency_muni, aes(xintercept = epi_week), linetype = "dotted", color = "black", size = 1.5) +
  geom_vline(data = emergency_state_for_muni_plot, aes(xintercept = epi_week), linetype = "dashed", color = "black", size = 1.5)

print(sum_risk_muni)
ggsave(here("Graphs/Risk Levels of Arbovirus (Sum) Outbreak in 2024 per Municipality with Emergency Dec.png"), sum_risk_muni, height = 10, width = 12, dpi = 300, create.dir = TRUE)
```

## Mapping First Week Alert in 2024

```{r mapping-firstweekalert, fig.width=12, fig.height=10}
# Filter for virus data and rename columns for joining
dengue_alert_week_state_filtered <- alert_week_state %>%
 filter(virus == "Dengue") %>%
 rename(uf = location_name)

dengue_alert_week_muni_filtered <- alert_week_muni %>%
 filter(virus == "Dengue") %>%
  rename(municipality = location_name)

# Join the alert week data with the geospatial data
# States
dengue_map_alert_states <- states_sf %>%
 left_join(dengue_alert_week_state_filtered, by = c("abbrev_state" = "uf"))

# Capitals
dengue_map_alert_capitals <- capitals_points %>%
 left_join(dengue_alert_week_muni_filtered, by = c("code_muni" = "ibge"))

# Breaks
dengue_week_breaks <- c(5, 9, 12, Inf)

dengue_week_labels <- c("Week 5-8", "Week 9-12", "Week 12+")

dengue_map_alert_states <- dengue_map_alert_states %>%
 mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
 mutate(alert_week_group = cut(first_week_alert_2024,
 breaks = dengue_week_breaks,
 labels = dengue_week_labels,
 include.lowest = TRUE,
 right = FALSE))
 
dengue_map_alert_capitals <- dengue_map_alert_capitals %>%
 mutate(first_week_alert_2024 = as.numeric(first_week_alert_2024)) %>%
 mutate(alert_week_group = cut(first_week_alert_2024,
 breaks = dengue_week_breaks,
 labels = dengue_week_labels,
 include.lowest = TRUE,
 right = FALSE))

# Generate the Map
#---------------------------------
dengue_risk_map_themed <- ggplot() +
 geom_sf(data = dengue_map_alert_states, aes(fill = alert_week_group), color = "black", linewidth = 0.5) +
 geom_sf(data = dengue_map_alert_capitals, aes(shape = alert_week_group),
 fill = NA, color = "darkgrey", alpha = 1, size = 4, stroke = 2) +
scale_fill_brewer(
    palette = "PuBuGn",
    name = "First Week 'Alert' (S)",
 drop = F
 ) +
 scale_shape_manual(
 name = "First Week 'Alert' (C)",
         values = c(21, 22, 23),
  na.translate = FALSE,
 drop = F
 ) +
   guides(
    fill = guide_legend(order = 1),
    shape = guide_legend(order = 2)
  ) +
 theme_bw() +
 theme(
 legend.position = c(0.8, 0.1),
 legend.justification = c("left", "bottom"),
 legend.background = element_rect(fill = "transparent"),
 legend.box.background = element_blank(),
 panel.grid = element_blank(),
 panel.border = element_blank(),
 axis.title = element_text(),
 axis.text = element_text()
 )

print(dengue_risk_map_themed)
ggsave(here("Graphs", "Map First Week Alert 2024.png"), dengue_risk_map_themed, width = 12, height = 10, dpi = 300)
```

## Mapping the lag between Alert and Emergency Declaration

```{r mapping-lag-diff, fig.width=12, fig.height=10}
# 1. Create the data frames for emergency declarations
emergency_week_state <- emergency_state %>%
  select(uf, declaration_week = epi_week)

# Select the IBGE code instead of the name for a reliable join
emergency_week_muni <- emergency_muni %>%
  select(ibge, declaration_week = epi_week)

# Define factor levels
lag_levels <- c(
  "Opportunistic",
  "Delayed",
  "No Declaration"
)

# States
lag_map_data_states <- states_sf %>%
  # Join alert data
  left_join(alert_week_state %>% filter(virus == "Dengue"), by = c("abbrev_state" = "location_name")) %>%
  # Join emergency declaration data (using the newly created df)
  left_join(emergency_week_state, by = c("abbrev_state" = "uf")) %>%
  mutate(
    # Calculate the difference in epidemiological weeks
    lag_weeks = declaration_week - first_week_alert_2024,
    
    # Create the categories based on the lag
    lag_category = case_when(
      is.na(declaration_week) ~ "No Declaration",
      lag_weeks == 0 ~ "Opportunistic",
      lag_weeks >=1 ~ "Delayed"
    ),
    
    # Convert to a factor to control the order in the plot legend
        lag_category = factor(lag_category, levels = lag_levels))

# Munis
lag_map_data_capitals <- capitals_points %>%
  # Join alert data (this join is already correct)
  left_join(alert_week_muni %>% filter(virus == "Dengue"), by = c("code_muni" = "ibge")) %>%
  # Join emergency declaration data BY IBGE CODE for reliability
  left_join(emergency_week_muni, by = c("code_muni" = "ibge")) %>%
  # Ensure we only have the selected capitals with data
  filter(!is.na(location_name)) %>%
  mutate(
    # Calculate the difference in epidemiological weeks
    lag_weeks = declaration_week - first_week_alert_2024,
    
    # Create the categories based on the lag
    lag_category = case_when(
      is.na(declaration_week) ~ "No Declaration",
      lag_weeks == 0 ~ "Opportunistic",
      lag_weeks >=1 ~ "Delayed"
    ),
    
    # Convert to a factor to control the order in the plot legend
       lag_category = factor(lag_category, levels = lag_levels))

# Generate the Map
lag_map <- ggplot() +
  geom_sf(data = lag_map_data_states, aes(fill = lag_category), color = "black", linewidth = 0.5) +
  geom_sf(data = lag_map_data_capitals, aes(shape = lag_category),
          fill = NA, color = "darkgrey", alpha = 1, size = 4, stroke = 2) +
  scale_fill_brewer(
    palette = "RdBu",
    name = "Timeliness of Emergency Declaration (S)",
    drop = T, 
    na.translate = F
  ) +
  scale_shape_manual(
    name = "Timeliness of Emergency Declaration (C)",
            values = c(6, 7, 8),
    drop = T, 
    na.translate = F
  ) +
   guides(
    fill = guide_legend(order = 1),
    shape = guide_legend(order = 2)
  ) +
  theme_bw() +
 theme(
  legend.position = c(0.8, 0.1),
  legend.justification = c("left", "bottom"),
  legend.background = element_rect(fill = "transparent"),
  legend.box.background = element_blank(),
  panel.grid = element_blank(),
  panel.border = element_blank(),
  axis.title = element_text(),
  axis.text = element_text()
 )

print(lag_map)
ggsave(here("Graphs", "Map_Lag_Alert_Declaration_2024.png"), lag_map, width = 12, height = 10, dpi = 300)
```